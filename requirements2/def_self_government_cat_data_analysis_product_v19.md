# [自治体猫データ分析プロダクト]のAWSアーキテクチャ設計書
## ゴール: 自治体猫データ分析プロダクトv19

## 1. 目的
本システムは、自治体が収集した猫に関するデータを分析し、地域の猫問題に対する施策立案を支援することを目的としている。AWSを活用することで、スケーラブルで信頼性の高いインフラを構築し、迅速なデータ処理と分析を実現する。

## 2. アーキテクチャ概要図
```
+---------------+    +---------------+    +---------------+
|     S3 Bucket  |    |   Lambda     |    |  API Gateway  |
+---------------+    +---------------+    +---------------+
       |                     |                     |
       |                     |                     |
+---------------+    +---------------+    +---------------+
|   Glue Crawler|    |   Glue Spark  |    |     EC2       |
+---------------+    +---------------+    +---------------+
       |                     |                     |
       |                     |                     |
+---------------+    +---------------+    +---------------+
|   Athena      |    |   QuickSight  |    |     RDS       |
+---------------+    +---------------+    +---------------+
```

## 3. AWSサービスの選択
- **S3 Bucket**: 猫データの格納と保管
  - 選択理由: 大容量のデータを低コストで保管でき、高い可用性と耐久性を提供する
- **Lambda**: 猫データの前処理とトランスフォーメーション
  - 選択理由: サーバレスで自動スケーリングが可能、コストが従量制のため、データ量に合わせて柔軟にリソースを調整できる
- **API Gateway**: 猫データの分析結果を提供するAPIエンドポイント
  - 選択理由: 高可用性と耐障害性を備え、セキュリティ機能も充実している
- **Glue Crawler/Spark**: 猫データのETL処理
  - 選択理由: 大量のデータを効率的に処理し、スキーマ変更にも柔軟に対応できる
- **Athena**: 猫データの分析
  - 選択理由: サーバレスで手軽に使え、SQL言語で直接データを分析できる
- **QuickSight**: 猫データの可視化
  - 選択理由: ダッシュボードの作成が容易で、インタラクティブな分析が可能
- **EC2**: 外部ツールの実行
  - 選択理由: 特殊な処理を行う必要がある場合に、柔軟にカスタマイズできる
- **RDS**: 猫データの永続化
  - 選択理由: 高可用性と信頼性が高く、SQLデータベースとして安定した動作が期待できる

## 4. 各AWSサービスの設定
- **S3 Bucket**:
  - バケット名: cats-data-bucket
  - バージョニング: 有効
  - 暗号化: AES-256
  - 設定理由: 猫データを安全に保管し、バージョン管理と暗号化を行う

- **Lambda**:
  - ランタイム: Python 3.9
  - メモリサイズ: 512MB
  - タイムアウト: 3分
  - 環境変数: RDS接続情報
  - 設定理由: 猫データの前処理とトランスフォーメーションを効率的に実行する

- **API Gateway**:
  - エンドポイントタイプ: Regional
  - セキュリティ: API Keyによる認証
  - 設定理由: 分析結果をセキュアに提供し、利用者の認証を行う

- **Glue Crawler**:
  - データソース: S3バケット
  - スケジュール: 毎日0時
  - 設定理由: 新しい猫データが定期的にS3に追加されるため、スキーマ変更に柔軟に対応する

- **Glue Spark**:
  - ジョブタイプ: Sparkバッチ処理
  - リソース: 2 x m5.xlarge
  - ジョブパラメータ: S3バケット情報、RDS接続情報
  - 設定理由: 大量の猫データをETL処理し、分析用のデータを生成する

- **Athena**:
  - データカタログ: Glueデータカタログ
  - クエリ結果の出力先: S3バケット
  - 設定理由: 分析用のデータに直接SQLクエリを実行し、結果をS3に出力する

- **QuickSight**:
  - データソース: Athena
  - ダッシュボード: 猫の個体数推移、地域別の特徴など
  - 設定理由: 分析結果を視覚的に表現し、意思決定を支援する

- **EC2**:
  - インスタンスタイプ: m5.large
  - AMI: Amazon Linux 2
  - 用途: 特殊な分析ツールの実行
  - 設定理由: 特定の分析処理を柔軟に実行する

- **RDS**:
  - エンジン: PostgreSQL 13.x
  - インスタンスクラス: db.t3.medium
  - ストレージ: 500GB
  - 設定理由: 猫データを永続的に保管し、高い可用性と信頼性を確保する

## 5. ネットワーク構成
- **VPCのCIDRブロック**: 10.0.0.0/16
- **パブリックサブネット**:
  - CIDR: 10.0.1.0/24
  - 用途: API Gateway, EC2
- **プライベートサブネット**:
  - CIDR: 10.0.2.0/24
  - 用途: RDS, Glue, Lambda
- **セキュリティグループ**:
  - インバウンド: HTTP(80), HTTPS(443)
  - アウトバウンド: 全て許可
- **NACL**:
  - インバウンド: HTTP(80), HTTPS(443), RDS(5432)
  - アウトバウンド: 全て許可

## 6. 可用性と耐障害性
- **マルチAZ構成**: RDSをマルチAZ構成とし、可用性と耐障害性を高める
- **オートスケーリング**: Lambdaとglue Sparkジョブにオートスケーリングを設定し、データ量の変動に合わせてリソースを自動調整する
- **ロードバランシング**: API Gatewayにロードバランサーを設定し、リクエストを効率的に分散する

## 7. セキュリティ対策
- **IAMによるアクセス制御**: 各AWSサービスへのアクセス権限を最小限に設定する
- **暗号化**: S3のサーバー側暗号化、RDSの暗号化ストレージを有効化する
- **WAF**: API GatewayにWAFを設定し、悪意のあるリクエストを遮断する

## 8. 運用・保守
- **CloudWatch**: AWSリソースのモニタリングとアラート設定を行う
- **CloudTrail**: AWSリソースの変更履歴を記録し、セキュリティ監視に活用する
- **AWS Config**: AWSリソースの設定変更を追跡し、コンプライアンス確認に活用する