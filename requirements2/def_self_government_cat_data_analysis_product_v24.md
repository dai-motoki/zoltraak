# AWSアーキテクチャ設計書
## ゴール: 自治体猫データ分析プロダクトv24

## 1. 目的
本システムは、自治体の猫の情報を収集・分析し、飼育管理や地域活性化につなげることを目的としている。AWS上に構築することで、スケーラビリティ、可用性、セキュリティの確保が期待できる。

## 2. ファイル・フォルダ構成
```
- frontend/
  - index.html
  - app.js
  - components/
    - Header.vue
    - Footer.vue
- backend/
  - app.py
  - models.py
  - requirements.txt
- infra/
  - main.tf
  - variables.tf
  - outputs.tf
- tests/
  - test_app.py
  - test_models.py
- assets/
  - images/
    - aws_architecture.png
```

## 3. AWSアーキテクチャ概要図
![](./assets/images/aws_architecture.png)

## 4. AWSサービスの選択
### VPC
- **サービス名**: VPC
- **用途**: 仮想ネットワーク環境の構築
- **選択理由**: セキュリティ強化、プライベートサブネットの設定、ルーティング制御が可能

### EC2
- **サービス名**: EC2
- **用途**: Webアプリケーションサーバー、バックエンドAPI
- **選択理由**: 高い柔軟性と拡張性を持つ、必要に応じてスケーリングが可能

### RDS
- **サービス名**: RDS
- **用途**: 猫の情報を保持するデータベース
- **選択理由**: 管理が容易で高可用性を実現できる

### S3
- **サービス名**: S3
- **用途**: 猫の画像データの保存
- **選択理由**: 大容量データの保管、高い可用性と耐久性を持つ

### CloudFront
- **サービス名**: CloudFront
- **用途**: Webアプリケーションのコンテンツ配信
- **選択理由**: CDNによるコンテンツ配信の高速化、SSL/TLSによるセキュリティ強化

### Lambda
- **サービス名**: Lambda
- **用途**: 非同期処理、データ変換
- **選択理由**: サーバーレスアーキテクチャ、スケーラビリティ、コスト最適化

### API Gateway
- **サービス名**: API Gateway
- **用途**: RESTful APIの管理
- **選択理由**: セキュリティ強化、モニタリング、スケーリング

### CloudWatch
- **サービス名**: CloudWatch
- **用途**: システムの監視、ログ管理
- **選択理由**: 包括的な監視と通知機能、ログ分析

### IAM
- **サービス名**: IAM
- **用途**: アクセス制御
- **選択理由**: 細かなアクセス権限の設定が可能

### WAF
- **サービス名**: WAF
- **用途**: Webアプリケーションのセキュリティ
- **選択理由**: 悪意のある入力の検知と遮断

## 5. 各AWSサービスの設定
### VPC
- **VPCのCIDRブロック**: 10.0.0.0/16
- **パブリックサブネット**: 10.0.1.0/24, 10.0.2.0/24
- **プライベートサブネット**: 10.0.10.0/24, 10.0.11.0/24
- **インターネットゲートウェイ**: 設定
- **ルートテーブル**: パブリックサブネット用、プライベートサブネット用

### EC2
- **インスタンスタイプ**: t3.medium
- **AMI**: Amazon Linux 2
- **ストレージ**: 100GB EBS
- **セキュリティグループ**: HTTP/HTTPS, SSH

### RDS
- **エンジン**: PostgreSQL 12.7
- **インスタンスクラス**: db.t3.medium
- **ストレージ**: 200GB
- **マルチAZ**: 有効化
- **バックアップ保持期間**: 7日

### S3
- **バケット名**: cat-data-bucket
- **バージョニング**: 有効化
- **暗号化**: AES-256

### CloudFront
- **オリジン**: S3バケット
- **キャッシュ設定**: 3600秒
- **SSL/TLS**: ACMで発行した証明書を使用

### Lambda
- **ランタイム**: Python 3.8
- **メモリサイズ**: 512MB
- **タイムアウト**: 30秒

### API Gateway
- **エンドポイントタイプ**: Regional
- **セキュリティ**: API Keyによる認証
- **ロギング**: CloudWatch Logs

### CloudWatch
- **ロググループ**: 各サービスごとに設定
- **アラーム**: CPU utilization, 5xx errors

### IAM
- **ポリシー**: 最小権限の原則に基づき設定
- **ロール**: EC2インスタンス用、Lambdaファンクション用

### WAF
- **ルール**: SQLインジェクション、XSS対策
- **WebACL**: デフォルトでブロック、例外リストを設定

## 6. ネットワーク構成
### VPC
- **VPCのCIDRブロック**: 10.0.0.0/16

### サブネット
- **パブリックサブネット**: 10.0.1.0/24, 10.0.2.0/24
  - EC2インスタンス(Webサーバー)
  - NAT Gateway
- **プライベートサブネット**: 10.0.10.0/24, 10.0.11.0/24
  - EC2インスタンス(APIサーバー)
  - RDSインスタンス

### セキュリティグループ
- **Webサーバー**: HTTP(80), HTTPS(443), SSH(22)
- **APIサーバー**: HTTP(8000), HTTPS(8443)
- **RDS**: PostgreSQL(5432)

### NACL
- **パブリックサブネット**: HTTP, HTTPS, SSH
- **プライベートサブネット**: PostgreSQL

## 7. 可用性と耐障害性
- **マルチAZ構成**: RDSを複数AZにデプロイ
- **Auto Scaling**: EC2インスタンスをオートスケーリンググループで管理
- **ロードバランサー**: Application Load Balancerを使用

## 8. セキュリティ対策
- **IAMによるアクセス制御**: 最小権限の原則に基づきポリシーを設定
- **暗号化**: S3のサーバー側暗号化、RDSの透過的データ暗号化
- **WAF**: SQLインジェクション、XSS対策のルールを設定

## 9. 運用・保守
- **CloudWatch**: EC2/RDS/Lambdaの監視、アラーム設定
- **CloudTrail**: APIコールのログ記録
- **AWS Config**: リソースの設定変更を記録、コンプライアンス確認

## まとめ
本アーキテクチャは、AWSのベストプラクティスに基づき設計されており、スケーラビリティ、可用性、セキュリティ、運用効率を兼ね備えている。また、コスト最適化の観点から、適切なリソース選択と活用を行っている。本設計書に基づき、自治体猫データ分析プロダクトv24を構築することができる。