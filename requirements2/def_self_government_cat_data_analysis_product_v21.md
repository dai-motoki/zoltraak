# AWSアーキテクチャ設計書
## ゴール: 自治体猫データ分析プロダクトv21

## 1. 目的
本システムは、自治体の猫に関するデータを収集、分析し、地域の猫対策を支援することを目的としている。
AWSを使用することで、スケーラビリティ、可用性、セキュリティ、運用効率の高いシステム構築が可能となる。

## 2. ファイル・フォルダ構成
- Markdown形式で省略なしのディレクトリ、ファイル構成
- ルートディレクトリから下層のディレクトリの中の複数ファイル名まで網羅的に記載（内容は必要なし）
- 空のディレクトリを作らない
- frontend/
- backend/
- infra/
- assets/images/class.png
- assets/images/sequence.png

## 2. AWSアーキテクチャ概要図
![](./assets/images/aws_architecture.png)

## 3. AWSサービスの選択
- **Amazon S3**: データ保管用のオブジェクトストレージ。大量のデータを格納し、高い可用性と耐障害性を実現できる。
- **Amazon Athena**: S3に保管されたデータに対するサーバーレスのクエリ実行サービス。ETLの手間を省くことができる。
- **Amazon Kinesis Data Streams**: リアルタイムのデータストリーミングを処理するためのサービス。猫の位置情報などの入力データを取り込む。
- **AWS Lambda**: イベント駆動型のサーバーレスコンピューティングサービス。ストリーミングデータの前処理やデータ分析ロジックの実行に使用する。
- **Amazon Elasticsearch Service**: 高速な全文検索と分析を行うためのマネージドサービス。猫の位置情報や特徴量の検索に使用する。
- **Amazon Cognito**: ユーザー認証と認可を管理するサービス。自治体職員のアクセス制御に使用する。
- **Amazon CloudWatch**: システムの監視、ログ管理、アラート通知を行うサービス。システムの運用監視に活用する。

## 4. 各AWSサービスの設定
### Amazon S3
- バケット名: "cat-data-v21"
- オブジェクトのバージョニング: 有効化
- サーバーサイド暗号化: AES-256

### Amazon Athena
- データカタログ: Glueデータカタログを使用
- クエリ結果の出力先: S3バケット"cat-data-v21"

### Amazon Kinesis Data Streams
- ストリーム名: "cat-position-stream"
- シャード数: 10
- データの保持期間: 24時間

### AWS Lambda
- 関数名: "cat-data-preprocessor"
- ランタイム: Python 3.9
- メモリサイズ: 512MB
- タイムアウト: 30秒
- トリガー: Kinesis Data Streams "cat-position-stream"

### Amazon Elasticsearch Service
- ドメイン名: "cat-search-domain"
- インスタンスタイプ: r6g.large.elasticsearch
- レプリカ数: 1

### Amazon Cognito
- ユーザープール名: "cat-data-users"
- アプリクライアントID: "cat-data-client"

### Amazon CloudWatch
- ロググループ名: "/cat-data-v21/logs"
- メトリクス: EC2、Lambda、Kinesis、Elasticsearch の監視

## 5. ネットワーク構成
### VPC
- CIDR ブロック: 10.0.0.0/16

### サブネット
- パブリックサブネット (2AZ): 
  - 10.0.1.0/24, 10.0.2.0/24
- プライベートサブネット (2AZ):
  - 10.0.10.0/24, 10.0.20.0/24

### セキュリティグループ
- 全てのインバウンド: 拒否
- 全てのアウトバウンド: 許可

### NACL
- インバウンド: HTTPトラフィック(80)、HTTPSトラフィック(443)を許可
- アウトバウンド: 全てのトラフィックを許可

## 6. 可用性と耐障害性
- マルチAZでEC2インスタンスとデータベースを構成し、可用性を確保する
- Auto Scalingを使用し、負荷に応じてスケーリングする
- Elastic Loadバランサーを使用し、トラフィックを分散する
- Amazon Kinesisのシャード数を適切に設定し、ストリーミングデータの処理能力を確保する

## 7. セキュリティ対策
- IAMを使用し、最小権限の原則に基づいてアクセス制御を行う
- Amazon Cognitoでユーザー認証と認可を管理する
- S3とElasticsearchのデータは暗号化する
- AWS WAFを使用し、一般的な Web 攻撃からシステムを保護する

## 8. 運用・保守
- CloudWatchを使用し、リソースの利用状況、ログ、アラートを監視する
- CloudTrailを使用し、AWS環境の変更履歴を記録する
- AWS Configを使用し、AWS リソースの設定を監視し、変更を検知する

以上のようなAWSアーキテクチャを構築することで、自治体猫データ分析プロダクトv21のニーズを満たすことができると考えます。
コスト最適化の観点から、適切なインスタンスタイプの選択、リザーブドインスタンスの活用、不要なリソースの削除などを検討していきます。